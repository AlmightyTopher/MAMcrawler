<!DOCTYPE html>
<html lang="en" class="dark">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MAM Stats Panel</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Inter:wght@400;600;800&display=swap');

        body {
            font-family: 'Inter', sans-serif;
            background-color: #0f172a;
            color: #e2e8f0;
        }

        .font-mono {
            font-family: 'JetBrains Mono', monospace;
        }

        .glass-panel {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        .stat-card {
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-2px);
            background: rgba(30, 41, 59, 0.9);
            border-color: rgba(16, 185, 129, 0.3);
        }

        /* Animations */
        @keyframes spin-slow {
            from {
                transform: rotate(0deg);
            }

            to {
                transform: rotate(360deg);
            }
        }

        .animate-spin-slow {
            animation: spin-slow 3s linear infinite;
        }
    </style>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        mam: {
                            500: '#10b981',
                            600: '#059669',
                            glow: '#34d399'
                        }
                    }
                }
            }
        }
    </script>
</head>

<body class="min-h-screen bg-[url('https://grainy-gradients.vercel.app/noise.svg')] p-6">

    <div id="app" class="max-w-7xl mx-auto space-y-6">

        <!-- Header -->
        <header class="glass-panel rounded-xl p-6 flex justify-between items-center">
            <div class="flex items-center gap-4">
                <div
                    class="w-12 h-12 rounded-full bg-mam-500/20 flex items-center justify-center border border-mam-500/50">
                    <i data-lucide="bar-chart-2" class="w-6 h-6 text-mam-500"></i>
                </div>
                <div>
                    <h1 class="text-2xl font-bold text-white tracking-tight">MyAnonamouse <span
                            class="text-mam-500">Stats</span></h1>
                    <div class="text-xs text-slate-400 font-mono flex items-center gap-2">
                        <span v-if="stats.updated_at">Last Updated: {{ formatTime(stats.updated_at) }}</span>
                        <span v-else>No data available</span>
                        <span v-if="loading" class="text-mam-500 animate-pulse">â€¢ Refreshing...</span>
                    </div>
                </div>
            </div>
            <div class="flex gap-3">
                <a href="/"
                    class="px-4 py-2 rounded-lg bg-slate-800 hover:bg-slate-700 text-slate-300 text-sm font-medium transition-colors flex items-center gap-2">
                    <i data-lucide="layout-dashboard" class="w-4 h-4"></i> Dashboard
                </a>
                <button @click="refreshStats" :disabled="loading"
                    class="px-4 py-2 rounded-lg bg-mam-600 hover:bg-mam-500 text-white text-sm font-bold shadow-lg shadow-mam-500/20 transition-all flex items-center gap-2 disabled:opacity-50">
                    <i data-lucide="refresh-cw" class="w-4 h-4" :class="{'animate-spin': loading}"></i>
                    Refresh Data
                </button>
            </div>
        </header>

        <!-- Shorthand Status Line -->
        <div class="glass-panel rounded-xl p-4 border-l-4 border-mam-500">
            <div class="text-xs text-slate-400 font-bold uppercase tracking-widest mb-2 flex justify-between">
                <span>Shorthand Status Line</span>
                <button @click="copyShorthand"
                    class="text-mam-500 hover:text-white transition-colors flex items-center gap-1">
                    <i data-lucide="copy" class="w-3 h-3"></i> Copy
                </button>
            </div>
            <div class="font-mono text-sm text-white bg-slate-900/50 p-3 rounded border border-slate-700/50 break-all">
                {{ stats.shorthand || 'Waiting for data...' }}
            </div>
        </div>

        <!-- Main Stats Grid -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">

            <!-- Ratio -->
            <div class="glass-panel rounded-xl p-6 stat-card relative overflow-hidden">
                <div class="absolute top-0 right-0 p-4 opacity-5">
                    <i data-lucide="percent" class="w-32 h-32"></i>
                </div>
                <div class="text-sm text-slate-400 font-medium uppercase tracking-wider mb-2">Current Ratio</div>
                <div class="flex items-end gap-3 mb-4">
                    <div class="text-4xl font-bold text-white">{{ formatNumber(stats.ratio, 3) }}</div>
                    <div class="text-sm font-mono mb-1" :class="getRatioColor(stats.ratio)">
                        {{ getRatioLabel(stats.ratio) }}
                    </div>
                </div>
                <!-- Visual Bar -->
                <div class="w-full bg-slate-700/50 h-2 rounded-full overflow-hidden">
                    <div class="h-full rounded-full transition-all duration-1000"
                        :class="getRatioColor(stats.ratio, true)"
                        :style="{ width: Math.min(stats.ratio * 20, 100) + '%' }"></div>
                </div>
            </div>

            <!-- Bonus Points -->
            <div class="glass-panel rounded-xl p-6 stat-card relative overflow-hidden">
                <div class="absolute top-0 right-0 p-4 opacity-5">
                    <i data-lucide="gift" class="w-32 h-32"></i>
                </div>
                <div class="text-sm text-slate-400 font-medium uppercase tracking-wider mb-2">Bonus Points</div>
                <div class="text-3xl font-bold text-mam-500 font-mono mb-2">
                    {{ formatNumber(stats.bonus_points, 0) }}
                </div>
                <div class="text-xs text-slate-500">
                    Available for purchase
                </div>
            </div>

            <!-- Uploaded -->
            <div class="glass-panel rounded-xl p-6 stat-card">
                <div class="text-sm text-slate-400 font-medium uppercase tracking-wider mb-2">Uploaded</div>
                <div class="text-3xl font-bold text-blue-400 font-mono mb-2">
                    {{ stats.uploaded || '---' }}
                </div>
                <div class="flex flex-col gap-1 text-xs text-slate-500">
                    <div class="flex items-center gap-2">
                        <i data-lucide="arrow-up" class="w-3 h-3"></i> Total Transfer
                    </div>
                    <div v-if="stats.real_uploaded" class="text-slate-600 font-mono">
                        (Real: {{ stats.real_uploaded }})
                    </div>
                </div>
            </div>

            <!-- Downloaded -->
            <div class="glass-panel rounded-xl p-6 stat-card">
                <div class="text-sm text-slate-400 font-medium uppercase tracking-wider mb-2">Downloaded</div>
                <div class="text-3xl font-bold text-purple-400 font-mono mb-2">
                    {{ stats.downloaded || '---' }}
                </div>
                <div class="flex flex-col gap-1 text-xs text-slate-500">
                    <div class="flex items-center gap-2">
                        <i data-lucide="arrow-down" class="w-3 h-3"></i> Total Transfer
                    </div>
                    <div v-if="stats.real_downloaded" class="text-slate-600 font-mono">
                        (Real: {{ stats.real_downloaded }})
                    </div>
                </div>
            </div>
        </div>

        <!-- Secondary Stats -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">

            <!-- User Profile -->
            <div class="glass-panel rounded-xl p-6">
                <h2 class="text-lg font-bold text-white mb-4 flex items-center gap-2">
                    <i data-lucide="user" class="w-5 h-5 text-mam-500"></i> Profile Details
                </h2>
                <div class="space-y-4">
                    <div class="flex justify-between items-center p-3 bg-slate-800/30 rounded-lg">
                        <span class="text-slate-400">Class</span>
                        <span class="font-bold text-white">{{ stats.class || 'Unknown' }}</span>
                    </div>
                    <div class="flex justify-between items-center p-3 bg-slate-800/30 rounded-lg">
                        <span class="text-slate-400">Join Date</span>
                        <span class="font-mono text-sm">{{ stats.join_date || 'Unknown' }}</span>
                    </div>
                    <div class="flex justify-between items-center p-3 bg-slate-800/30 rounded-lg">
                        <span class="text-slate-400">Status</span>
                        <span class="px-2 py-1 rounded text-xs font-bold bg-green-500/20 text-green-400">Active</span>
                    </div>
                </div>
            </div>

            <!-- Activity -->
            <div class="glass-panel rounded-xl p-6">
                <h2 class="text-lg font-bold text-white mb-4 flex items-center gap-2">
                    <i data-lucide="activity" class="w-5 h-5 text-mam-500"></i> Activity
                </h2>
                <div class="grid grid-cols-2 gap-4">
                    <div class="p-4 bg-slate-800/30 rounded-lg text-center">
                        <div class="text-2xl font-bold text-blue-400">{{ stats.seeding || 0 }}</div>
                        <div class="text-xs text-slate-500 uppercase mt-1">Seeding</div>
                    </div>
                    <div class="p-4 bg-slate-800/30 rounded-lg text-center">
                        <div class="text-2xl font-bold text-purple-400">{{ stats.leeching || 0 }}</div>
                        <div class="text-xs text-slate-500 uppercase mt-1">Leeching</div>
                    </div>
                    <div class="p-4 bg-slate-800/30 rounded-lg text-center col-span-2">
                        <div class="text-2xl font-bold text-white">{{ (stats.seeding || 0) + (stats.leeching || 0) }}
                        </div>
                        <div class="text-xs text-slate-500 uppercase mt-1">Total Active Torrents</div>
                    </div>
                </div>
            </div>

            <!-- Raw Data / Other -->
            <div class="glass-panel rounded-xl p-6 lg:col-span-1">
                <h2 class="text-lg font-bold text-white mb-4 flex items-center gap-2">
                    <i data-lucide="database" class="w-5 h-5 text-slate-400"></i> Additional Data
                </h2>
                <div class="space-y-2 max-h-64 overflow-y-auto pr-2 custom-scrollbar">
                    <div v-for="(value, key) in stats.raw_data" :key="key"
                        class="flex justify-between items-center text-sm p-2 border-b border-slate-700/50 hover:bg-slate-800/30 rounded">
                        <span class="text-slate-400 capitalize">{{ key.replace(/_/g, ' ') }}</span>
                        <span class="font-mono text-slate-200">{{ value }}</span>
                    </div>
                    <div v-if="!stats.raw_data || Object.keys(stats.raw_data).length === 0"
                        class="text-center text-slate-500 py-4 italic">
                        No additional data found
                    </div>
                </div>
            </div>
        </div>

        <!-- Notification Area -->
        <div v-if="error" class="glass-panel border-red-500/30 bg-red-500/10 p-4 rounded-xl flex items-center gap-3">
            <i data-lucide="alert-circle" class="w-5 h-5 text-red-400"></i>
            <span class="text-red-200 text-sm">{{ error }}</span>
            <button @click="error = null" class="ml-auto text-red-400 hover:text-white">
                <i data-lucide="x" class="w-4 h-4"></i>
            </button>
        </div>

    </div>

    <script>
        const { createApp, ref, onMounted } = Vue;

        createApp({
            setup() {
                const stats = ref({
                    ratio: 0,
                    bonus_points: 0,
                    uploaded: '---',
                    downloaded: '---',
                    raw_data: {},
                    shorthand: ''
                });
                const loading = ref(false);
                const error = ref(null);

                const formatNumber = (num, decimals = 2) => {
                    if (num === undefined || num === null) return '0';
                    return new Intl.NumberFormat('en-US', {
                        minimumFractionDigits: decimals,
                        maximumFractionDigits: decimals
                    }).format(num);
                };

                const formatTime = (isoString) => {
                    if (!isoString) return '';
                    return new Date(isoString).toLocaleString();
                };

                const getRatioColor = (ratio, bg = false) => {
                    if (ratio < 1.0) return bg ? 'bg-red-500' : 'text-red-500';
                    if (ratio < 2.0) return bg ? 'bg-yellow-500' : 'text-yellow-500';
                    return bg ? 'bg-mam-500' : 'text-mam-500';
                };

                const getRatioLabel = (ratio) => {
                    if (ratio < 0.6) return 'CRITICAL';
                    if (ratio < 1.0) return 'WARNING';
                    if (ratio < 2.0) return 'GOOD';
                    return 'EXCELLENT';
                };

                const fetchStats = async () => {
                    try {
                        const res = await fetch('/api/stats');
                        const data = await res.json();
                        if (data && Object.keys(data).length > 0) {
                            stats.value = data;
                        }
                    } catch (e) {
                        console.error("Failed to fetch stats", e);
                    }
                };

                const refreshStats = async () => {
                    loading.value = true;
                    error.value = null;
                    try {
                        const res = await fetch('/api/stats/refresh', { method: 'POST' });
                        if (!res.ok) throw new Error('Refresh failed');

                        // Poll for updates
                        let attempts = 0;
                        const interval = setInterval(async () => {
                            attempts++;
                            await fetchStats();
                            // If timestamp changed significantly (more than 1 min from old), stop
                            // Or just stop after a few seconds
                            if (attempts > 10) {
                                clearInterval(interval);
                                loading.value = false;
                            }
                        }, 2000);

                    } catch (e) {
                        error.value = "Failed to trigger refresh. System might be busy.";
                        loading.value = false;
                    }
                };

                const copyShorthand = async () => {
                    if (stats.value.shorthand) {
                        try {
                            await navigator.clipboard.writeText(stats.value.shorthand);
                            // Optional: Show toast
                        } catch (e) {
                            console.error('Failed to copy', e);
                        }
                    }
                };

                onMounted(() => {
                    lucide.createIcons();
                    fetchStats();
                    // Auto refresh view every minute
                    setInterval(fetchStats, 60000);
                });

                return {
                    stats,
                    loading,
                    error,
                    formatNumber,
                    formatTime,
                    getRatioColor,
                    getRatioLabel,
                    refreshStats,
                    copyShorthand
                };
            }
        }).mount('#app');
    </script>
</body>

</html>