<!DOCTYPE html>
<html lang="en" class="dark">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MAM Crawler // Command Center</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Inter:wght@400;600;800&display=swap');

        body {
            font-family: 'Inter', sans-serif;
            background-color: #0f172a;
            color: #e2e8f0;
        }

        .font-mono {
            font-family: 'JetBrains Mono', monospace;
        }

        .glass-panel {
            background: rgba(15, 23, 42, 0.9);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(148, 163, 184, 0.35);
            box-shadow:
                0 10px 25px rgba(15, 23, 42, 0.7),
                0 0 0 1px rgba(15, 23, 42, 0.9);
        }

        @keyframes pulse-glow {

            0%,
            100% {
                box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.8);
            }

            50% {
                box-shadow: 0 0 12px 2px rgba(16, 185, 129, 0.8);
            }
        }

        .animate-pulse-glow {
            animation: pulse-glow 2s ease-in-out infinite;
        }

        .cursor {
            display: inline-block;
            width: 8px;
            height: 14px;
            background-color: #22c55e;
            animation: blink 1s step-end infinite;
            vertical-align: middle;
            margin-left: 2px;
        }

        @keyframes blink {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0;
            }
        }

        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #020617;
        }

        ::-webkit-scrollbar-thumb {
            background: #1e293b;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #334155;
        }
    </style>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        mam: {
                            500: '#22c55e',
                            600: '#16a34a'
                        }
                    }
                }
            }
        }
    </script>
</head>

<body class="h-screen overflow-hidden bg-slate-950">

    <div id="app" class="flex flex-col h-full">

        <!-- HEADER -->
        <header class="h-16 glass-panel border-b border-slate-800 flex items-center justify-between px-6">
            <div class="flex items-center gap-3">
                <div class="w-3 h-3 rounded-full bg-mam-500 animate-pulse-glow"></div>
                <h1 class="text-xl font-bold tracking-wider text-white">
                    MAM<span class="text-mam-500">CRAWLER</span> // COMMAND CENTER
                </h1>
            </div>

            <!-- SERVICE STATUS INDICATORS -->
            <div class="flex items-center gap-6">
                <template v-for="service in services" :key="service.name">
                    <a v-if="service.url" :href="service.url" target="_blank"
                        class="flex items-center gap-2 group cursor-pointer hover:opacity-80 transition-opacity">
                        <div class="w-2 h-2 rounded-full transition-all duration-300" :class="(!connected || isHealthStale || service.status !== 'running')
                                ? 'bg-red-500 group-hover:shadow-[0_0_8px_rgba(239,68,68,0.6)]'
                                : 'bg-mam-500 animate-pulse group-hover:shadow-[0_0_8px_rgba(34,197,94,0.6)]'">
                        </div>
                        <span
                            class="text-xs font-bold text-slate-400 group-hover:text-mam-500 transition-colors uppercase tracking-wider">
                            {{ service.name }}
                        </span>
                    </a>
                    <div v-else class="flex items-center gap-2">
                        <div class="w-2 h-2 rounded-full" :class="(!connected || isHealthStale || service.status !== 'running')
                                ? 'bg-red-500'
                                : 'bg-mam-500 animate-pulse'">
                        </div>
                        <span class="text-xs font-bold text-slate-400 uppercase tracking-wider">
                            {{ service.name }}
                        </span>
                    </div>
                </template>
            </div>

            <div class="flex items-center gap-6 text-sm font-mono text-slate-400">
                <a href="/stats-panel"
                    class="hover:text-mam-500 transition-colors flex items-center gap-2 bg-slate-900/70 px-3 py-1.5 rounded-lg border border-slate-700 hover:border-mam-500/60"
                    title="Open Full Stats Panel">
                    <i data-lucide="layout-template" class="w-4 h-4"></i>
                    <span>Stats Panel</span>
                </a>

                <div class="w-px h-4 bg-slate-700"></div>

                <div class="flex items-center gap-2">
                    <i data-lucide="clock" class="w-4 h-4"></i>
                    <span>{{ currentTime }}</span>
                </div>

                <div class="flex items-center gap-2">
                    <i data-lucide="wifi" :class="['w-4 h-4', connected ? 'text-mam-500' : 'text-red-500']"></i>
                    <span :class="connected ? 'text-mam-500' : 'text-red-500'">
                        {{ connected ? 'ONLINE' : 'OFFLINE' }}
                    </span>
                </div>
            </div>
        </header>

        <!-- MAIN GRID -->
        <main class="flex-1 grid grid-cols-12 gap-6 p-6 overflow-hidden">

            <!-- LEFT COLUMN -->
            <div class="col-span-12 lg:col-span-4 flex flex-col gap-6 overflow-y-auto pr-1">

                <!-- SHORTHAND STATUS LINE -->
                <div class="glass-panel rounded-xl p-4 border-l-4 border-mam-500">
                    <div class="flex items-center justify-between mb-2">
                        <div class="text-xs font-bold uppercase tracking-widest text-slate-400">
                            Status Line
                        </div>
                        <button @click="copyShorthand"
                            class="text-xs text-mam-500 hover:text-white transition-colors flex items-center gap-1">
                            <i data-lucide="copy" class="w-3 h-3"></i>
                            <span>Copy</span>
                        </button>
                    </div>
                    <div
                        class="font-mono text-lg font-bold text-mam-500 drop-shadow-[0_0_5px_rgba(34,197,94,0.5)] bg-slate-900/80 p-3 rounded border border-slate-700/70 break-words leading-relaxed">
                        {{ stats.shorthand || 'Waiting for data...' }}
                    </div>
                </div>

                <!-- MANUAL OVERRIDE (MOVED UP) -->
                <div class="glass-panel rounded-xl p-6">
                    <h2 class="text-slate-400 text-xs font-bold uppercase tracking-widest mb-4">
                        Manual Override
                    </h2>
                    <div class="grid grid-cols-2 gap-3">
                        <button @click="triggerAction('top-search')" :disabled="loading"
                            class="bg-mam-600 hover:bg-mam-500 text-white p-3 rounded-lg font-semibold text-sm transition-all flex items-center justify-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed">
                            <i data-lucide="search" class="w-4 h-4"></i>
                            <span>Top Search</span>
                        </button>
                        <button @click="triggerAction('update-metadata')" :disabled="loading"
                            class="bg-slate-800 hover:bg-slate-700 text-white p-3 rounded-lg font-semibold text-sm transition-all flex items-center justify-center gap-2 disabled:opacity-50">
                            <i data-lucide="refresh-cw" class="w-4 h-4"></i>
                            <span>Metadata</span>
                        </button>
                        <button @click="triggerAction('missing-books')" :disabled="loading"
                            class="bg-slate-800 hover:bg-slate-700 text-white p-3 rounded-lg font-semibold text-sm transition-all flex items-center justify-center gap-2 disabled:opacity-50 col-span-2">
                            <i data-lucide="scan" class="w-4 h-4"></i>
                            <span>Detect Missing Books</span>
                        </button>
                        <button @click="triggerAction('sync-goodreads')" :disabled="loading"
                            class="bg-indigo-600 hover:bg-indigo-500 text-white p-3 rounded-lg font-semibold text-sm transition-all flex items-center justify-center gap-2 disabled:opacity-50">
                            <i data-lucide="book-open" class="w-4 h-4"></i>
                            <span>Sync Goodreads</span>
                        </button>
                        <button @click="triggerAction('scan-fantasy')" :disabled="loading"
                            class="bg-purple-600 hover:bg-purple-500 text-white p-3 rounded-lg font-semibold text-sm transition-all flex items-center justify-center gap-2 disabled:opacity-50">
                            <i data-lucide="sparkles" class="w-4 h-4"></i>
                            <span>Scan Top Fantasy</span>
                        </button>
                    </div>
                </div>

            </div>

            <!-- MIDDLE COLUMN (Expanded) -->
            <div class="col-span-12 lg:col-span-8 flex flex-col gap-6 overflow-hidden">

                <!-- LIVE TERMINAL -->
                <div class="glass-panel rounded-xl p-0 flex flex-col overflow-hidden h-[32rem]">
                    <div class="p-3 border-b border-slate-800 bg-slate-950 flex items-center justify-between">
                        <div class="flex items-center gap-2">
                            <i data-lucide="terminal-square" class="w-4 h-4 text-mam-500"></i>
                            <h2 class="text-slate-400 text-xs font-bold uppercase tracking-widest">
                                Live Terminal
                            </h2>
                        </div>
                    </div>
                    <div ref="terminalContainer"
                        class="flex-1 bg-black p-4 overflow-y-auto font-mono text-xs text-green-400 space-y-1">
                        <div v-if="terminalLogs.length === 0" class="text-slate-700 italic">
                            Waiting for output...
                        </div>
                        <div v-for="(line, index) in terminalLogs" :key="index" class="whitespace-pre-wrap break-all">{{
                            line }}</div>
                    </div>
                </div>

                <!-- ACTIVE DOWNLOADS -->
                <div class="glass-panel rounded-xl p-6 flex-1 flex flex-col overflow-hidden min-h-[16rem]">
                    <div class="flex items-center justify-between mb-4">
                        <h2 class="text-slate-400 text-xs font-bold uppercase tracking-widest">
                            Active Downloads
                        </h2>
                        <span class="text-xs bg-slate-900/80 px-2 py-1 rounded text-slate-300 border border-slate-700">
                            {{ queue.length }} Items
                        </span>
                    </div>

                    <div class="flex-1 overflow-y-auto pr-1 space-y-2">
                        <div v-for="item in queue" :key="item.hash"
                            class="bg-slate-900/70 p-3 rounded-lg border border-slate-800 hover:border-slate-600 transition-colors">
                            <div class="flex items-center justify-between mb-1">
                                <h3 class="text-sm font-medium text-slate-100 truncate w-3/4" :title="item.name">
                                    {{ item.name }}
                                </h3>
                                <span class="text-xs font-mono" :class="getStatusColor(item.state)">
                                    {{ item.state }}
                                </span>
                            </div>
                            <div class="flex items-center gap-3 text-xs text-slate-400 mb-2">
                                <span>{{ item.size }}</span>
                                <span>•</span>
                                <span class="text-mam-500">↓ {{ item.dlspeed }}</span>
                                <span>•</span>
                                <span class="text-blue-400">↑ {{ item.upspeed }}</span>
                            </div>
                            <div class="w-full bg-slate-800 rounded-full h-1 overflow-hidden">
                                <div class="bg-mam-600 h-1 rounded-full transition-all"
                                    :style="{ width: (item.progress * 100) + '%' }"></div>
                            </div>
                        </div>

                        <div v-if="queue.length === 0" class="text-center text-slate-500 py-8 text-sm italic">
                            No active downloads.
                        </div>
                    </div>
                </div>

            </div>

        </main>
    </div>

    <script>
        const { createApp, ref, onMounted, nextTick, computed } = Vue;
        const { createIcons } = lucide;

        createApp({
            setup() {
                const connected = ref(true);
                const currentTime = ref('');
                const loading = ref(false);
                const terminalContainer = ref(null);
                const terminalLogs = ref([]);

                const stats = ref({
                    shorthand: ''
                });

                const services = ref([
                    { name: 'Audiobookshelf', status: 'running', url: 'http://localhost:13378' },
                    { name: 'qBittorrent', status: 'running', url: 'http://localhost:8080' },
                    { name: 'Prowlarr', status: 'stopped', url: 'http://localhost:9696' }
                ]);

                const queue = ref([]);

                // health tracking
                const lastHealthUpdate = ref(Date.now());
                const isHealthStale = computed(() => {
                    return Date.now() - lastHealthUpdate.value > 6000; // > ~3 missed polls
                });

                const lastServiceState = ref({});

                const getStatusColor = (state) => {
                    if (!state) return 'text-slate-500';
                    const lower = state.toLowerCase();
                    if (lower.includes('downloading')) return 'text-green-400';
                    if (lower.includes('stalled')) return 'text-slate-500';
                    if (lower.includes('error')) return 'text-red-500';
                    return 'text-blue-400';
                };

                const triggerAction = async (action) => {
                    terminalLogs.value = []; // Clear logs for new action
                    loading.value = true;
                    let endpoint = '';
                    let label = '';

                    if (action === 'top-search') {
                        endpoint = '/api/actions/top-search';
                        label = 'Top Search';
                    } else if (action === 'update-metadata') {
                        endpoint = '/api/actions/refresh-metadata';
                        label = 'Metadata Refresh';
                    } else if (action === 'missing-books') {
                        endpoint = '/api/actions/detect-missing';
                        label = 'Missing Books Detection';
                    } else if (action === 'sync-goodreads') {
                        endpoint = '/api/actions/sync-goodreads';
                        label = 'Goodreads Sync';
                    } else if (action === 'scan-fantasy') {
                        endpoint = '/api/actions/scan-fantasy';
                        label = 'Fantasy Scan';
                    } else {
                        console.error(`Endpoint for ${action} not implemented`);
                        loading.value = false;
                        return;
                    }

                    try {
                        const res = await fetch(endpoint, {
                            method: 'POST',
                            headers: {
                                'X-MAM-Client': 'Dashboard'
                            }
                        });
                        // We rely on logs to show success/failure
                    } catch (e) {
                        console.error(`Failed to start ${label}: ${e.message}`);
                    } finally {
                        loading.value = false;
                    }
                };

                const fetchData = async () => {
                    try {
                        const res = await fetch('/api/status');
                        const data = await res.json();

                        if (data && typeof data === 'object') {
                            if (data.stats) {
                                stats.value = data.stats;
                            }

                            const allowedServiceNames = ['Audiobookshelf', 'qBittorrent', 'Prowlarr'];
                            const rawServices = Array.isArray(data.services) ? data.services : [];

                            const normalizedServices = rawServices
                                .filter(s => {
                                    if (!s || !s.name) return false;
                                    const mappedName = (s.name === 'Docker Desktop' ? 'Prowlarr' : s.name);
                                    return allowedServiceNames.includes(mappedName);
                                })
                                .map(s => {
                                    const name = (s.name === 'Docker Desktop' ? 'Prowlarr' : s.name);
                                    const status = s.status === 'running' ? 'running' : 'stopped';
                                    return {
                                        ...s,
                                        name,
                                        status
                                    };
                                });

                            services.value = normalizedServices;
                            queue.value = Array.isArray(data.queue) ? data.queue : [];

                            // Process Raw Logs for Terminal
                            if (data.recent_logs && Array.isArray(data.recent_logs)) {
                                terminalLogs.value = data.recent_logs.map(log => {
                                    if (typeof log === 'string') return log;
                                    if (log && log.message) {
                                        // Simple reconstruction
                                        return `[${log.time}] ${log.level} - ${log.message}`;
                                    }
                                    return JSON.stringify(log);
                                });
                                // Scroll to bottom
                                nextTick(() => {
                                    if (terminalContainer.value) {
                                        terminalContainer.value.scrollTop = terminalContainer.value.scrollHeight;
                                    }
                                });
                            }
                        }

                        connected.value = true;
                        lastHealthUpdate.value = Date.now();
                    } catch (e) {
                        connected.value = false;
                    }
                };

                const copyShorthand = async () => {
                    if (!stats.value.shorthand) return;
                    try {
                        await navigator.clipboard.writeText(stats.value.shorthand);
                    } catch (e) {
                        console.error('Failed to copy shorthand', e);
                    }
                };

                onMounted(() => {
                    createIcons();

                    currentTime.value = new Date().toLocaleTimeString();
                    setInterval(() => {
                        currentTime.value = new Date().toLocaleTimeString();
                    }, 1000);

                    fetchData();
                    setInterval(fetchData, 1000);
                });

                return {
                    connected,
                    currentTime,
                    loading,
                    stats,
                    services,
                    queue,
                    terminalLogs,
                    terminalContainer,
                    getStatusColor,
                    triggerAction,
                    copyShorthand,
                    isHealthStale
                };
            }
        }).mount('#app');
    </script>
</body>

</html>